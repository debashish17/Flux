// Prisma Schema for Flux Document Generation Platform
// Database: Supabase PostgreSQL

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int               @id @default(autoincrement())
  email          String            @unique
  hashedPassword String            @map("hashed_password")
  createdAt      DateTime          @default(now()) @map("created_at")
  projects       Project[]
  feedback       SectionFeedback[]
  comments       SectionComment[]
  chatMessages   ChatMessage[]

  @@map("users")
}

model Project {
  id           Int               @id @default(autoincrement())
  title        String
  type         String            // "docx" or "pptx"
  prompt       String?           @db.Text // Original user prompt for generation
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @default(now()) @updatedAt @map("updated_at")
  userId       Int               @map("user_id")
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  sections     DocumentSection[]
  chatMessages ChatMessage[]

  @@index([userId])
  @@map("projects")
}

model DocumentSection {
  id          Int                 @id @default(autoincrement())
  title       String
  content     String?             @db.Text // Markdown or structured text
  htmlContent String?             @db.Text @map("html_content") // HTML for preview
  orderIndex  Int                 @map("order_index")
  projectId   Int                 @map("project_id")
  project     Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  history     RefinementHistory[]
  feedback    SectionFeedback[]
  comments    SectionComment[]

  @@index([projectId])
  @@map("document_sections")
}

model RefinementHistory {
  id              Int             @id @default(autoincrement())
  sectionId       Int             @map("section_id")
  prompt          String          @db.Text
  previousContent String          @db.Text @map("previous_content")
  newContent      String          @db.Text @map("new_content")
  createdAt       DateTime        @default(now()) @map("created_at")
  section         DocumentSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
  @@map("refinement_history")
}

model SectionFeedback {
  id        Int             @id @default(autoincrement())
  sectionId Int             @map("section_id")
  userId    Int             @map("user_id")
  type      String          // "like" or "dislike"
  createdAt DateTime        @default(now()) @map("created_at")
  section   DocumentSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sectionId, userId]) // One feedback per user per section
  @@index([sectionId])
  @@index([userId])
  @@map("section_feedback")
}

model SectionComment {
  id        Int             @id @default(autoincrement())
  sectionId Int             @map("section_id")
  userId    Int             @map("user_id")
  comment   String          @db.Text
  createdAt DateTime        @default(now()) @map("created_at")
  section   DocumentSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sectionId])
  @@index([userId])
  @@map("section_comments")
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  userId    Int      @map("user_id")
  role      String   // "user" or "assistant"
  message   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@map("chat_messages")
}
